@* ChatBox Component - å…±ç”¨èŠå¤©ä»‹é¢ *@

<div class="chat-box @(DualPane ? "dual-pane" : "")">
    @if (!string.IsNullOrEmpty(Title))
    {
        <div class="chat-header">
            <span>@Title</span>
            @if (ShowClearButton)
            {
                <button class="btn btn-sm" @onclick="OnClear">æ¸…é™¤</button>
            }
        </div>
    }
    
    <div class="chat-messages" @ref="_messagesContainer">
        @foreach (var msg in Messages)
        {
            <div class="chat-message @(msg.IsUser ? "user" : "assistant")">
                <div class="message-avatar">@(msg.IsUser ? "ğŸ‘¤" : "ğŸ¤–")</div>
                <div class="message-content">
                    <div class="message-text">@((MarkupString)msg.Content)</div>
                    @if (!string.IsNullOrEmpty(msg.Metadata))
                    {
                        <div class="message-metadata">@msg.Metadata</div>
                    }
                </div>
            </div>
        }
        
        @if (IsLoading)
        {
            <div class="chat-message assistant">
                <div class="message-avatar">ğŸ¤–</div>
                <div class="message-content">
                    <div class="message-text loading">æ€è€ƒä¸­...</div>
                </div>
            </div>
        }
    </div>
    
    <div class="chat-input-area">
        <input type="text" 
               class="chat-input" 
               placeholder="@Placeholder"
               @bind="InputText"
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               disabled="@IsLoading" />
        <button class="btn btn-primary" 
                @onclick="SendMessage" 
                disabled="@(IsLoading || string.IsNullOrWhiteSpace(InputText))">
            ç™¼é€
        </button>
    </div>
</div>

@code {
    [Parameter] public string Title { get; set; } = "";
    [Parameter] public string Placeholder { get; set; } = "è¼¸å…¥è¨Šæ¯...";
    [Parameter] public bool DualPane { get; set; } = false;
    [Parameter] public bool ShowClearButton { get; set; } = true;
    [Parameter] public List<ChatMessageItem> Messages { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; } = false;
    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnClear { get; set; }
    
    private string InputText = "";
    private ElementReference _messagesContainer;
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(InputText) && !IsLoading)
        {
            await SendMessage();
        }
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(InputText)) return;
        
        var message = InputText;
        InputText = "";
        await OnSend.InvokeAsync(message);
    }
}

@* è¨Šæ¯é …ç›®é¡åˆ¥ *@
@code {
    public class ChatMessageItem
    {
        public bool IsUser { get; set; }
        public string Content { get; set; } = "";
        public string? Metadata { get; set; }
    }
}
