@page "/"
@rendermode InteractiveServer
@inject LlmService LlmService
@inject AgentService AgentService
@inject McpService McpService
@inject IStringLocalizer<SharedResource> L

<CultureProvider />

<PageTitle>@L["Title"]</PageTitle>

<div class="playground">
    <header class="page-header">
        <h1>🧪 @L["Title"]</h1>
        <p>@L["Subtitle"]</p>
    </header>

    <!-- Level 1: Pure LLM -->
    <section id="level1" class="level-section">
        <div class="level-header">
            <span class="level-badge">L1</span>
            <div class="level-title">
                <h2>@L["L1_Title"]</h2>
                <p>@L["L1_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(1)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>var response = await chatClient.CompleteChatAsync("@GetDisplayInput(_level1Input, _level1LastInput)");</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level1Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@msg.Content</span>
                    </div>
                }
                @if (_level1Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：退貨流程是什麼？" 
                       @bind="_level1Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 1)" disabled="@_level1Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(1)" 
                        disabled="@(_level1Loading || string.IsNullOrWhiteSpace(_level1Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-problem">@L["L1_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L1_Arrow"]</div>

    <!-- Level 2: System Prompt -->
    <section id="level2" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L2</span>
            <div class="level-title">
                <h2>@L["L2_Title"]</h2>
                <p>@L["L2_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(2)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>var systemPrompt = "你是電商客服，退貨期限 7 天...";
var userMessage = "@GetDisplayInput(_level2Input, _level2LastInput)";
var response = await chatClient.CompleteChatAsync(userMessage, systemPrompt);</code></pre>
        </details>
        <div class="prompt-box">📝 @_systemPrompt</div>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level2Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@msg.Content</span>
                    </div>
                }
                @if (_level2Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：退貨期限是幾天？ (有 System Prompt)" 
                       @bind="_level2Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 2)" disabled="@_level2Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(2)" 
                        disabled="@(_level2Loading || string.IsNullOrWhiteSpace(_level2Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L2_Solution"]</div>
        <div class="level-problem">@L["L2_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L2_Arrow"]</div>

    <!-- Level 3: Few-shot -->
    <section id="level3" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L3</span>
            <div class="level-title">
                <h2>@L["L3_Title"]</h2>
                <p>@L["L3_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(3)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>var systemPrompt = "擷取退貨商品與原因，輸出 JSON";
// Few-shot Examples (Teaching by example)
var examples = new [] 
{
    ("我要退藍色襯衫，因為太小", "{\"item\":\"藍色襯衫\",\"reason\":\"太小\"}"),
    ("退貨無線耳機，音質不好", "{\"item\":\"無線耳機\",\"reason\":\"音質不好\"}")
};

var userMessage = "@GetDisplayInput(_level3Input, _level3LastInput)";
var response = await chatClient.CompleteChatAsync(userMessage, systemPrompt, examples);</code></pre>
        </details>
        <div class="examples-box">
            <strong>@L["Example"]：</strong>
            <code>"我要退這件衣服" → {{"item":"衣服","reason":"(未提供)"}}</code>
        </div>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level3Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level3Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：收到褲子結果破洞了 (擷取退貨資訊)" 
                       @bind="_level3Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 3)" disabled="@_level3Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(3)" 
                        disabled="@(_level3Loading || string.IsNullOrWhiteSpace(_level3Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L3_Solution"]</div>
        <div class="level-problem">@L["L3_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L3_Arrow"]</div>

    <!-- Level 4: Memory -->
    <section id="level4" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L4</span>
            <div class="level-title">
                <h2>@L["L4_Title"]</h2>
                <p>@L["L4_Desc"] (@L["Rounds"]: @(_level4History.Count / 2))</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(4)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>var messages = new List&lt;ChatMessage&gt;
{
    new SystemChatMessage(systemPrompt),
    // Add all history messages
    foreach (var (role, content) in history)
    {
        messages.Add(role == "user" 
            ? new UserChatMessage(content)
            : new AssistantChatMessage(content));
    }
    messages.Add(new UserChatMessage("@GetDisplayInput(_level4Input, _level4LastInput)"));
};
var response = await chatClient.CompleteChatAsync(messages);</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level4Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@msg.Content</span>
                    </div>
                }
                @if (_level4Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="@L["L4_Placeholder"]" 
                       @bind="_level4Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 4)" disabled="@_level4Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(4)" 
                        disabled="@(_level4Loading || string.IsNullOrWhiteSpace(_level4Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L4_Solution"]</div>
        <div class="level-problem">@L["L4_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L4_Arrow"]</div>

    <!-- Level 5: RAG -->
    <section id="level5" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L5</span>
            <div class="level-title">
                <h2>@L["L5_Title"]</h2>
                <p>@L["L5_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(5)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// 1. Search Return Policy
var policy = "退貨規章：生鮮食品不可退貨，3C 產品需在 7 天內...";

// 2. Add policy to prompt
var prompt = $"參考規章：{policy}\n\n回答用戶退貨問題：@GetDisplayInput(_level5Input, _level5LastInput)";

var response = await chatClient.CompleteChatAsync(prompt);</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level5Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level5Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：生鮮食品可以退嗎？ (RAG 檢索)" 
                       @bind="_level5Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 5)" disabled="@_level5Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(5)" 
                        disabled="@(_level5Loading || string.IsNullOrWhiteSpace(_level5Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L5_Solution"]</div>
        <div class="level-problem">@L["L5_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L5_Arrow"]</div>

    <!-- Level 6: Function Calling -->
    <section id="level6" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L6</span>
            <div class="level-title">
                <h2>@L["L6_Title"]</h2>
                <p>@L["L6_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(6)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// Define Tool
[Description("查詢訂單狀態")]
public static string GetOrderStatus(string orderId) { ... }

// Pass tool to AI
var options = new ChatCompletionOptions();
options.Tools.Add(GetOrderStatus); 
var response = await chatClient.CompleteChatAsync("@GetDisplayInput(_level6Input, _level6LastInput)", options);</code></pre>
        </details>
        <div class="tools-box">@L["L6_Tools"]</div>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level6Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level6Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"]</span></div> }
            </div>
            @if (_level6ToolCalls.Any())
            {
                <div class="tool-log">🔧 @string.Join(" → ", _level6ToolCalls.TakeLast(3).Select(t => t.ToolName))</div>
            }
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：幫我查訂單 ORD-2024001" 
                       @bind="_level6Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 6)" disabled="@_level6Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(6)" 
                        disabled="@(_level6Loading || string.IsNullOrWhiteSpace(_level6Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L6_Solution"]</div>
        <div class="level-problem">@L["L6_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L6_Arrow"]</div>

    <!-- Level 7: Agent -->
    <section id="level7" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L7</span>
            <div class="level-title">
                <h2>@L["L7_Title"]</h2>
                <p>@L["L7_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(7)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// Create Agent
var agent = new AIAgent(chatClient) 
{
    Instructions = "你負責處理退貨，先檢查狀態，符合資格再提交申請...",
    Tools = [GetOrderStatus, SubmitReturnRequest]
};

var response = await agent.RunAsync("@GetDisplayInput(_level7Input, _level7LastInput)");</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level7Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level7Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["AgentPlanning"]</span></div> }
            </div>
            @if (_level7ToolCalls.Any())
            {
                <div class="tool-log">🧠 @string.Join(" → ", _level7ToolCalls.TakeLast(5).Select(t => t.ToolName))</div>
            }
            <div class="input-row">
                <input type="text" class="form-control" placeholder="試試：我要退貨 ORD-2024001 因為尺寸不合" 
                       @bind="_level7Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 7)" disabled="@_level7Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(7)" 
                        disabled="@(_level7Loading || string.IsNullOrWhiteSpace(_level7Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L7_Solution"]</div>
        <div class="level-problem">@L["L7_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L7_Arrow"]</div>

    <!-- Level 8: MCP -->
    <section id="level8" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L8</span>
            <div class="level-title">
                <h2>@L["L8_Title"]</h2>
                <p>@L["L8_Desc"]</p>
            </div>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// Connect MCP Server (any compatible service)
var mcpClient = await McpClient.CreateAsync(              // Key
    new StdioClientTransport("npx", "mcp-server-xxx")
);

// Auto-discover all tools provided by the Server
var tools = await mcpClient.ListToolsAsync();             // Auto-discover

// Give tools to Agent — no custom integration code needed!
agent.Tools = tools.Select(t => t.ToAITool()).ToList();</code></pre>
        </details>
        <div class="mcp-explanation">
            <div class="mcp-before">@L["L8_Before"]</div>
            <div class="mcp-after">@L["L8_After"]</div>
        </div>
        <div class="mcp-example">
            <strong>🔗 Example: Microsoft Learn MCP</strong><br />
            <code>https://learn.microsoft.com/api/mcp</code><br />
            <small>Tools: microsoft_docs_search, microsoft_docs_fetch, microsoft_code_sample_search</small>
        </div>
        <div class="level-solution">@L["L8_Final"]</div> <!-- Changed from final class to normal -->
        <div class="level-problem">@L["L9_Problem"]</div> <!-- Reusing L9 problem text as L8 problem: System becomes complex -->
    </section>

    <div class="evolution-arrow">⬇️ LangGraph 解決</div>

    <!-- Level 9: LangGraph -->
    <section id="level9" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L9</span>
            <div class="level-title">
                <h2>@L["L9_Title"]</h2>
                <p>@L["L9_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(9)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// Define Graph
var workflow = new StateGraph&lt;AgentState&gt;("agent")
    .AddNode("planner", PlannerNode)
    .AddNode("executor", ExecutorNode)
    .AddEdge("planner", "executor")
    .AddConditionalEdges("executor", CheckDone);

var app = workflow.Compile();
var result = await app.InvokeAsync("@GetDisplayInput(_level9Input, _level9LastInput)");</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level9Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level9Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["L9_Desc"]...</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="@L["L9_Placeholder"]" 
                       @bind="_level9Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 9)" disabled="@_level9Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(9)" 
                        disabled="@(_level9Loading || string.IsNullOrWhiteSpace(_level9Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution">@L["L9_Solution"]</div>
        <div class="level-problem">@L["L9_Problem"]</div>
    </section>

    <div class="evolution-arrow">@L["L9_Arrow"]</div>

    <!-- Level 10: Observability -->
    <section id="level10" class="level-section evolved">
        <div class="level-header">
            <span class="level-badge">L10</span>
            <div class="level-title">
                <h2>@L["L10_Title"]</h2>
                <p>@L["L10_Desc"]</p>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="() => ClearLevel(10)">@L["Clear"]</button>
        </div>
        <details class="code-section">
            <summary>@L["ViewCode"]</summary>
            <pre><code>// LangSmith Tracing
using var trace = LangSmith.Trace("MyAgent");
trace.LogInput("@GetDisplayInput(_level10Input, _level10LastInput)");

// ... AI execution ...

trace.LogOutput(response);
// Dashboard shows: Latency: 1.2s, Tokens: 450, Cost: $0.002</code></pre>
        </details>
        <div class="level-content">
            <div class="chat-area">
                @foreach (var msg in _level10Messages)
                {
                    <div class="msg @(msg.IsUser ? "user" : "ai")">
                        <span class="msg-role">@(msg.IsUser ? "👤" : "🤖")</span>
                        <span class="msg-text">@((MarkupString)msg.Content)</span>
                    </div>
                }
                @if (_level10Loading) { <div class="msg ai"><span class="msg-role">🤖</span><span class="msg-text loading">@L["Thinking"] (Tracing)...</span></div> }
            </div>
            <div class="input-row">
                <input type="text" class="form-control" placeholder="@L["L10_Placeholder"]" 
                       @bind="_level10Input" @bind:event="oninput"
                       @onkeydown="e => HandleKeyDown(e, 10)" disabled="@_level10Loading" />
                <button class="btn btn-primary" @onclick="() => SendLevel(10)" 
                        disabled="@(_level10Loading || string.IsNullOrWhiteSpace(_level10Input))">@L["Send"]</button>
            </div>
        </div>
        <div class="level-solution final">@L["L10_Final"]</div>
    </section>

    <div class="evolution-arrow">⬇️ Skill Injection Extension</div>

    <!-- Level 11: Skills -->
    <L11_Skills />
</div>

@code {
    private string _level1Input = "", _level2Input = "", _level3Input = "", _level4Input = "", _level5Input = "", _level6Input = "", _level7Input = "", _level9Input = "", _level10Input = "";
    private string _level1LastInput = "退貨流程", _level2LastInput = "退貨流程", _level3LastInput = "我要退藍色襯衫，因為太小", _level4LastInput = "我叫小明", _level5LastInput = "退貨需要運費嗎？", _level6LastInput = "我的訂單 ORD-123 狀況?", _level7LastInput = "我要退貨 ORD-123", _level9LastInput = "寫一篇關於 AI 的文章並翻譯成英文", _level10LastInput = "你好";
    
    private List<MsgItem> _level1Messages = new(), _level2Messages = new(), _level3Messages = new(), _level4Messages = new(), _level5Messages = new(), _level6Messages = new(), _level7Messages = new(), _level9Messages = new(), _level10Messages = new();
    private bool _level1Loading, _level2Loading, _level3Loading, _level4Loading, _level5Loading, _level6Loading, _level7Loading, _level9Loading, _level10Loading;
    private List<(string Role, string Content)> _level4History = new();
    private List<ToolCallInfo> _level6ToolCalls = new(), _level7ToolCalls = new();
    
    private string _systemPrompt = "你是「快樂購物」電商客服。規則：回答簡潔、退貨期限 7 天、滿 500 免運。生鮮食品不可退貨。";
    private string _fewShotSystemPrompt = "你是退貨資訊擷取助手。請分析用戶對話，擷取「退貨商品(Item)」與「退貨原因(Reason)」。輸出 JSON 格式。";
    private List<(string User, string Assistant)> _fewShotExamples = new()
    {
        ("這件藍色襯衫太小了", "{\"item\":\"藍色襯衫\",\"reason\":\"尺寸太小\"}"),
        ("收到的耳機有雜音", "{\"item\":\"耳機\",\"reason\":\"功能瑕疵/雜音\"}"),
        ("我不想要這個了", "{\"item\":\"(未指定)\",\"reason\":\"個人因素\"}")
    };

    private string GetDisplayInput(string current, string last) => string.IsNullOrWhiteSpace(current) ? last : current;

    private async Task HandleKeyDown(KeyboardEventArgs e, int level) { if (e.Key == "Enter") await SendLevel(level); }
    private async Task SendLevel(int level) { switch (level) { case 1: await ProcessLevel1(); break; case 2: await ProcessLevel2(); break; case 3: await ProcessLevel3(); break; case 4: await ProcessLevel4(); break; case 5: await ProcessLevel5(); break; case 6: await ProcessLevel6(); break; case 7: await ProcessLevel7(); break; case 9: await ProcessLevel9(); break; case 10: await ProcessLevel10(); break; } }

    private async Task ProcessLevel1() { if (string.IsNullOrWhiteSpace(_level1Input)) return; var msg = _level1Input; _level1LastInput = msg; _level1Input = ""; _level1Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level1Loading = true; StateHasChanged(); try { var resp = await LlmService.ChatPureAsync(msg); _level1Messages.Add(new MsgItem { IsUser = false, Content = resp }); } catch (Exception ex) { _level1Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level1Loading = false; StateHasChanged(); }
    private async Task ProcessLevel2() { if (string.IsNullOrWhiteSpace(_level2Input)) return; var msg = _level2Input; _level2LastInput = msg; _level2Input = ""; _level2Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level2Loading = true; StateHasChanged(); try { var resp = await LlmService.ChatWithSystemPromptAsync(msg, _systemPrompt); _level2Messages.Add(new MsgItem { IsUser = false, Content = resp }); } catch (Exception ex) { _level2Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level2Loading = false; StateHasChanged(); }
    private async Task ProcessLevel3() { if (string.IsNullOrWhiteSpace(_level3Input)) return; var msg = _level3Input; _level3LastInput = msg; _level3Input = ""; _level3Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level3Loading = true; StateHasChanged(); try { var resp = await LlmService.ChatWithFewShotAsync(msg, _fewShotSystemPrompt, _fewShotExamples); var formatted = $"<code style='background:var(--bg-hover);padding:4px 8px;border-radius:4px;'>{resp}</code>"; _level3Messages.Add(new MsgItem { IsUser = false, Content = formatted }); } catch (Exception ex) { _level3Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level3Loading = false; StateHasChanged(); }
    private async Task ProcessLevel4() { if (string.IsNullOrWhiteSpace(_level4Input)) return; var msg = _level4Input; _level4LastInput = msg; _level4Input = ""; _level4Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level4Loading = true; StateHasChanged(); try { var resp = await LlmService.ChatWithHistoryAsync(msg, _systemPrompt, _level4History); _level4Messages.Add(new MsgItem { IsUser = false, Content = resp }); _level4History.Add(("user", msg)); _level4History.Add(("assistant", resp)); } catch (Exception ex) { _level4Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level4Loading = false; StateHasChanged(); }
    
    // Level 5: RAG Simulation
    private async Task ProcessLevel5() {
        if (string.IsNullOrWhiteSpace(_level5Input)) return; 
        var msg = _level5Input; _level5LastInput = msg; _level5Input = ""; 
        _level5Messages.Add(new MsgItem { IsUser = true, Content = msg }); 
        _level5Loading = true; StateHasChanged(); 
        await Task.Delay(1000); // Simulate search
        var ragContext = "📜 [退貨規章] 1. 生鮮食品一經出貨概不接受退貨。 2. 3C 產品若已拆封，非瑕疵品不得退貨。 3. 一般商品享有 7 天鑑賞期。";
        _level5Messages.Add(new MsgItem { IsUser = false, Content = $"🔍 檢索到資料：<br><code>{ragContext}</code>" });
        try { 
            // In real app, we pass context to LLM. Here we simulate or just call LLM pure with augmented prompt
            var prompt = $"參考資料：{ragContext}\n\n回答問題：{msg}";
            var resp = await LlmService.ChatPureAsync(prompt); 
            _level5Messages.Add(new MsgItem { IsUser = false, Content = resp }); 
        } catch (Exception ex) { _level5Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } 
        _level5Loading = false; StateHasChanged(); 
    }

    private async Task ProcessLevel6() { if (string.IsNullOrWhiteSpace(_level6Input)) return; var msg = _level6Input; _level6LastInput = msg; _level6Input = ""; _level6Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level6Loading = true; StateHasChanged(); try { var (resp, tools) = await AgentService.ChatWithToolsAsync(msg, _systemPrompt); _level6ToolCalls.AddRange(tools); var toolInfo = tools.Any() ? $"<br><small style='color:var(--accent)'>🔧 {string.Join(", ", tools.Select(t => t.ToolName))}</small>" : ""; _level6Messages.Add(new MsgItem { IsUser = false, Content = resp + toolInfo }); } catch (Exception ex) { _level6Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level6Loading = false; StateHasChanged(); }
    private async Task ProcessLevel7() { if (string.IsNullOrWhiteSpace(_level7Input)) return; var msg = _level7Input; _level7LastInput = msg; _level7Input = ""; _level7Messages.Add(new MsgItem { IsUser = true, Content = msg }); _level7Loading = true; StateHasChanged(); try { var (resp, tools) = await AgentService.RunAgentAsync(msg, _systemPrompt, new()); _level7ToolCalls.AddRange(tools); var toolInfo = tools.Any() ? $"<br><small style='color:var(--accent)'>🧠 Ran {tools.Count} steps</small>" : ""; _level7Messages.Add(new MsgItem { IsUser = false, Content = resp + toolInfo }); } catch (Exception ex) { _level7Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); } _level7Loading = false; StateHasChanged(); }

    // Level 9: LangGraph Simulation
    private async Task ProcessLevel9() {
        if (string.IsNullOrWhiteSpace(_level9Input)) return;
        var msg = _level9Input; _level9LastInput = msg; _level9Input = "";
        _level9Messages.Add(new MsgItem { IsUser = true, Content = msg });
        _level9Loading = true; StateHasChanged();
        await Task.Delay(1000);
        _level9Messages.Add(new MsgItem { IsUser = false, Content = "🕸️ [Graph] Start" });
        await Task.Delay(800);
        _level9Messages.Add(new MsgItem { IsUser = false, Content = "🟢 [Node] Planner: Analyzing request..." });
        await Task.Delay(800);
        _level9Messages.Add(new MsgItem { IsUser = false, Content = "🔵 [Node] Executor: Generating content..." });
        await Task.Delay(800);
        try {
            var resp = await LlmService.ChatPureAsync(msg);
            _level9Messages.Add(new MsgItem { IsUser = false, Content = $"🏁 [Graph] End: {resp}" });
        } catch (Exception ex) { _level9Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); }
        _level9Loading = false; StateHasChanged();
    }

    // Level 10: Observability Simulation
    private async Task ProcessLevel10() {
        if (string.IsNullOrWhiteSpace(_level10Input)) return;
        var msg = _level10Input; _level10LastInput = msg; _level10Input = "";
        _level10Messages.Add(new MsgItem { IsUser = true, Content = msg });
        _level10Loading = true; StateHasChanged();
        var stopWatch = System.Diagnostics.Stopwatch.StartNew();
        try {
            var resp = await LlmService.ChatPureAsync(msg);
            stopWatch.Stop();
            _level10Messages.Add(new MsgItem { IsUser = false, Content = resp });
            var traceInfo = $@"
<div style='background:var(--bg-sidebar);padding:8px;border-radius:6px;font-size:12px;margin-top:8px;border-left:3px solid var(--accent)'>
    <strong>🔬 LangSmith Trace</strong><br/>
    Trace ID: {Guid.NewGuid()}<br/>
    Latency: {stopWatch.ElapsedMilliseconds}ms<br/>
    Tokens: {msg.Length/3 + resp.Length/3} (approx)<br/>
    Model: gpt-4o<br/>
    Status: <span style='color:#22c55e'>SUCCESS</span>
</div>";
            _level10Messages.Add(new MsgItem { IsUser = false, Content = traceInfo });
        } catch (Exception ex) { _level10Messages.Add(new MsgItem { IsUser = false, Content = $"Error: {ex.Message}" }); }
        _level10Loading = false; StateHasChanged();
    }

    private void ClearLevel(int level) { switch (level) { case 1: _level1Messages.Clear(); break; case 2: _level2Messages.Clear(); break; case 3: _level3Messages.Clear(); break; case 4: _level4Messages.Clear(); _level4History.Clear(); break; case 5: _level5Messages.Clear(); break; case 6: _level6Messages.Clear(); _level6ToolCalls.Clear(); break; case 7: _level7Messages.Clear(); _level7ToolCalls.Clear(); break; case 9: _level9Messages.Clear(); break; case 10: _level10Messages.Clear(); break; } }
    private class MsgItem { public bool IsUser { get; set; } public string Content { get; set; } = ""; }
}
